name: "ğŸš€ Cross-Platform Release Build"

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*"
  workflow_dispatch:

jobs:
  # ----------------------------------------------------
  # JOB 1: å¹¶è¡Œæ„å»º (Fan-out)
  # ----------------------------------------------------
  build-assets:
    name: "Build ${{ matrix.asset_suffix }}" 
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - target: armv7-unknown-linux-musleabihf
            asset_suffix: echo-mate-armv7-musleabihf
            env_rustflags: "-C target-feature=+crt-static"


    steps:
      - name: "1. Checkout Repository"
        uses: actions/checkout@v4

      - name: "2. Install Rust Toolchain"
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: "3. Install 'cross'"
        run: cargo install cross --git https://github.com/cross-rs/cross --branch main

      - name: "4. Set Target-Specific Rustflags (via Env)"
        if: matrix.env_rustflags
        run: |
          TARGET_ENV_VAR=$(echo "CARGO_TARGET_${{ matrix.target }}" | tr '[:lower:]-' '[:upper:]_')"_RUSTFLAGS"
          echo "Setting $TARGET_ENV_VAR=${{ matrix.env_rustflags }}"
          echo "$TARGET_ENV_VAR=${{ matrix.env_rustflags }}" >> $GITHUB_ENV
          
      - name: "5. Build Static Binary"
        id: build
        env:
          PROGRAM_NAME: "provisioner"
        run: |
          BUILD_COMMAND="cross build --target=${{ matrix.target }} --release"
          if [ -n "${{ matrix.features }}" ]; then
            BUILD_COMMAND="$BUILD_COMMAND --features \"${{ matrix.features }}\""
          fi

          echo "Running: $BUILD_COMMAND"
          eval $BUILD_COMMAND
          
          SOURCE_PATH="target/${{ matrix.target }}/release/${PROGRAM_NAME}"
          DEST_NAME="${PROGRAM_NAME}-${{ matrix.asset_suffix }}"
          
          echo "Moving '$SOURCE_PATH' to '$DEST_NAME'"
          mv $SOURCE_PATH $DEST_NAME
          
          # å°†ç›®æ ‡æ–‡ä»¶åè¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "asset_path=$DEST_NAME" >> $GITHUB_OUTPUT

      # --- ä¸ä¸Šä¼ åˆ°Releaseï¼Œè€Œæ˜¯ä¿å­˜ä¸ºArtifact ---
      - name: "6. Upload Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.asset_path }} # ä½¿ç”¨å”¯ä¸€åç§°
          path: ${{ steps.build.outputs.asset_path }} # ä¸Šä¼ è¯¥æ–‡ä»¶
          retention-days: 1 # ä»…ä¿ç•™1å¤©

  # ----------------------------------------------------
  # JOB 2: åˆ›å»ºå¹¶å‘å¸ƒ (Fan-in)
  # ä½¿ç”¨ 'gh release create' ä¸€æ­¥åˆ°ä½å®Œæˆï¼š
  # 1. è‡ªåŠ¨ç”ŸæˆåŸºäº PR çš„ Release Notes
  # 2. åˆ›å»º Release
  # 3. ä¸Šä¼ æ‰€æœ‰äº§ç‰©
  # ----------------------------------------------------
  create-release:
    name: "Create & Publish Release"
    runs-on: ubuntu-latest
    
    # ç¡®ä¿æ‰€æœ‰æ„å»ºå®Œæˆåæ‰è¿è¡Œ
    needs: build-assets 
    
    permissions:
      contents: write # gh release create éœ€è¦è¿™ä¸ªæƒé™

    steps:

      - name: "1. Checkout Repository"
        uses: actions/checkout@v4

      - name: "2. Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          # ä¸æŒ‡å®š nameï¼Œä¼šä¸‹è½½æ‰€æœ‰ Artifacts
          path: artifacts # ä¸‹è½½åˆ° 'artifacts' æ–‡ä»¶å¤¹

      - name: "3. Create Release and Upload All Assets"
        env:
          # GITHUB_TOKEN æ˜¯è‡ªåŠ¨ç”± GitHub Actions æä¾›çš„
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¥ Found artifacts:"
          find artifacts -type f | while read asset_path; do
            asset_name=$(basename "$asset_path")
            echo "  - $asset_name"
          done
          
          # ä¸€æ¬¡æ€§åˆ›å»º Release å¹¶ä¸Šä¼ æ‰€æœ‰äº§ç‰©
          # --generate-notes: è‡ªåŠ¨åŸºäº PR ç”Ÿæˆ Release Notes
          # --title: æŒ‡å®š Release æ ‡é¢˜
          echo ""
          echo "ğŸš€ Creating Release ${{ github.ref_name }} with auto-generated notes..."
          
          gh release create \
            "${{ github.ref_name }}" \
            --title "Release ${{ github.ref_name }}" \
            --generate-notes \
            $(find artifacts -type f)
          
          echo ""
          echo "âœ… Release created successfully!"
          echo "ğŸ“¤ Assets uploaded:"
          find artifacts -type f | while read asset_path; do
            asset_name=$(basename "$asset_path")
            echo "  - Binary: $asset_name"
          done